/***
	sitePreloader.js
	Github: https://github.com/thisancog/sitePreloader
	License: MIT
 ***/

"use strict";class sitePreloader{constructor(e){this.entry=window.location.href,this.root=document.documentElement,this.body=document.querySelector("body"),this.wrapper=this.body,this.pages={},this.active=this.hashCode(this.entry),this.parseOptions(e),this.registerEvents()}parseOptions(e={}){let t={home:window.location.origin,wrapper:"body",linkSelector:"a",chacheImmediately:!0,cacheEntryPage:!0,delayBeforeSwitch:400,switchRootAttributes:!0,switchRootClasses:!0,switchBodyClasses:!0,switchWrapperClasses:!0,switchPageTitle:!0,smoothScroll:!0,onAfterPagePreload:null,onBeforeSwitch:null,onAfterSwitch:null,beforePageStorage:null};e=Object.assign(t,e),this.wrapper=document.querySelector(e.wrapper),this.wrapperSelector=e.wrapper,this.events={onAfterPagePreload:this.castAsArray(e.onAfterPagePreload),onBeforeSwitch:this.castAsArray(e.onBeforeSwitch),onAfterSwitch:this.castAsArray(e.onAfterSwitch)},this.filters={beforePageStorage:this.castAsArray(e.beforePageStorage)},delete e.wrapper,delete e.onAfterPagePreload,delete e.onBeforeSwitch,delete e.onAfterSwitch,delete e.beforePageStorage,Object.assign(this,e)}registerEvents(){this.cacheEntrySite(),this.scanLinks(),window.addEventListener("popstate",this.switchBack.bind(this))}cacheEntrySite(){this.cacheEntryPage&&this.createNewPageObject(this.entry)}scanLinks(){let e=this.linkSelector+'[href^="'+this.home+'"]:not([data-scanned]), '+this.linkSelector+'[href^="/"]:not([data-scanned])';this.body.querySelectorAll(e).forEach(function(e){if(e.target&&"_self"!==e.target&&"_top"!==e.target)return;if(e.href===this.entry&&!this.cacheEntryPage)return;const t=e.href;let s=this.hashCode(t),i={element:e,eventsRegistered:!1,url:t};if(e.dataset.scanned=!0,this.hookUpLink(i,s),this.has(this.pages,s))return this.pages[s].links.push(i);this.createNewPageObject(t,i)}.bind(this))}createNewPageObject(e,t=[]){const s=this.hashCode(e),i={bodyClasses:"",content:"",links:this.castAsArray(t),loaded:!1,rootAttributes:[],rootClasses:"",title:"",url:e,wrapperClasses:""};this.pages[s]=i,this.chacheImmediately&&this.preloadPage(s)}preloadPage(e){const t=this.pages[e].url;t===window.location.href?this.storePage(e,document):this.requestPage(t).then(function(t){this.storePage(e,t)}.bind(this)).catch(function(e){console.error("There was an error trying to fetch content: "+e.statusText+" â€“ Request-URL: "+t)})}storePage(e,t=document){if(!t)return;const s=this.pages[e].url;this.filters.beforePageStorage.length>0&&this.filters.beforePageStorage.forEach(e=>t=e(s,t));const i=t.querySelector(this.wrapperSelector),r={bodyClasses:t.querySelector("body").className,content:i.innerHTML,rootAttributes:[].slice.call(t.documentElement.attributes).map(e=>({name:e.name,value:e.value})).filter(e=>"class"!==e.name),loaded:!0,rootClasses:t.documentElement.className,title:t.querySelector("title").innerText,wrapperClasses:i.className};this.pages[e]=Object.assign(this.pages[e],r),this.events.onAfterPagePreload.length>0&&this.events.onAfterPagePreload.forEach((t=>t(this.pages[e])).bind(this))}hookUpLink(e,t){e.eventsRegistered||(e.element.addEventListener("mouseover",this.onMouseOverLink.bind(this)),e.element.addEventListener("mouseout",this.onMouseOutLink.bind(this)),e.element.addEventListener("click",this.onClickLink.bind(this)),e.eventsRegistered=!0)}onMouseOverLink(e){const t=this.getIdFromLink(e.target);this.root.classList.add("is-hovering-page-link"),this.pages[t].loaded||this.preloadPage(t)}onMouseOutLink(e){this.root.classList.remove("is-hovering-page-link")}onClickLink(e){const t=this.getIdFromLink(e.target);this.pages[t].loaded&&(e.preventDefault(),this.switchTo(t))}switchTo(e){if(e===this.active)return;const t=this.pages[e],s=this.smoothScroll?"smooth":"auto";this.events.onBeforeSwitch.length>0&&this.events.onBeforeSwitch.forEach(e=>e(t)),this.switchPageTitle&&(document.title=t.title),this.root.classList.add("is-changing-page"),setTimeout(function(){this.wrapper.innerHTML=t.content,this.switchWrapperClasses&&(this.wrapper.classList=t.wrapperClasses),this.switchBodyClasses&&(this.body.className=t.bodyClasses),this.switchRootClasses&&(this.root.className=t.rootClasses+" is-changing-page"),this.switchRootAttributes&&t.rootAttributes.forEach((e=>this.root.setAttribute(e.name,e.value)).bind(this)),this.events.onAfterSwitch.length>0&&this.events.onAfterSwitch.forEach(e=>e(t)),window.history.pushState({id:e,url:t.url},t.title,t.url),window.scrollTo({top:0,behavior:s}),setTimeout(function(){this.root.classList.remove("is-changing-page"),this.scanLinks(),this.active=e}.bind(this),400)}.bind(this),this.delayBeforeSwitch)}switchBack(e){if(!e.state||!e.state.id)return;const t=e.state.id;if(!this.pages[t])return window.location.href=e.state.url;this.switchTo(t)}hashCode(e){return Math.abs(e.replace(/\/$/,"").split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0))}getIdFromLink(e){for(;"A"!==e.tagName&&(!e.dataset||!e.dataset.scanned)&&e.parentElement;)e=e.parentElement;if("A"===e.tagName&&e.dataset&&e.dataset.scanned)return this.hashCode(e.href)}has(e,t){return Object.prototype.hasOwnProperty.call(e,t)}castAsArray(e=null){return Array.isArray(e)?e:null===e?[]:[e]}requestPage(e){return new Promise(function(t,s){let i=new XMLHttpRequest;"withCredentials"in i||("undefined"!=typeof XDomainRequest?i=new XDomainRequest:s({status:400,statusText:"This browser does not support XMLHttpRequests or XDomainRequests."})),i.responseType="document",i.open("GET",e),i.onload=function(){i.status>=200&&i.status<300?t(i.response):s({status:i.status,statusText:i.statusText})},i.onerror=function(){s({status:i.status,statusText:i.statusText})},i.send()}.bind(this))}}